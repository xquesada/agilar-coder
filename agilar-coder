#!/usr/bin/env bash
#
# agilar-coder - Run Claude Code unattended on a Product Backlog
#

set -euo pipefail

VERSION="1.0"
CONFIG_DIR="$HOME/.agilar-coder"
CONFIG_FILE="$CONFIG_DIR/config.conf"
STATUS_FILE=".agilar-status"

# Default configuration values
DEFAULT_MODEL="opus"
DEFAULT_MAX_TURNS="100"
DEFAULT_VERBOSE="false"
DEFAULT_USER_PROMPT='Implement the next PBI of the Product Backlog [FILE_NAME]. When you are done with all tasks and all tests pass, commit the new feature and push if you know how to, and verify that the CI is green using the CLI if you know how to. Once everything passes, update the Product Backlog document to indicate the progress we achieved.'

# Fixed prompt (hardcoded)
FIXED_PROMPT='You are processing a Product Backlog. Your task:

1. Parse the provided backlog file and identify all PBIs (Product Backlog Items)
2. Find the FIRST PBI that is NOT marked as DONE
3. Implement that ONE PBI completely
4. Update the backlog file to mark that PBI as DONE
5. Write a status file ".agilar-status" in the current directory with:
   TOTAL=<total number of PBIs>
   REMAINING=<number of PBIs not yet DONE>
   LAST_PBI=<identifier or title of the PBI you just completed>
   STATUS=<success|error>

If there are no PBIs, or all PBIs are already DONE, write:
   TOTAL=<count>
   REMAINING=0
   LAST_PBI=none
   STATUS=success

If the backlog is invalid or you encounter an error, write:
   STATUS=error
   ERROR=<description>

IMPORTANT: Work on exactly ONE PBI per execution. Do not continue to the next PBI.'

# ─────────────────────────────────────────────────────────────────────────────
# Functions
# ─────────────────────────────────────────────────────────────────────────────

show_help() {
    cat <<'EOF'
agilar-coder - Run Claude Code unattended on a Product Backlog

USAGE:
    agilar-coder <backlog-file> [count]
    agilar-coder -h | --help
    agilar-coder --debug <backlog-file> [count]

ARGUMENTS:
    backlog-file    Path to markdown file containing the Product Backlog
    count           (Optional) Number of PBIs to process
                    If omitted, runs until backlog is empty

OPTIONS:
    -h, --help      Show this help message
    --debug         Show full command without executing

CONFIGURATION:
    ~/.agilar-coder/config.conf

    Available settings:
        USER_PROMPT   Custom instructions for Claude (git, CI, etc.)
        MODEL         Claude model to use (default: opus)
        MAX_TURNS     Max turns per PBI (default: 100)
        VERBOSE       Enable verbose output (default: false)

EXAMPLES:
    agilar-coder backlog.md          Process all PBIs until done
    agilar-coder backlog.md 3        Process exactly 3 PBIs
    agilar-coder ./docs/sprint.md    Use backlog from subdirectory

EXIT CODES:
    0    Success
    1    Backlog file not found
    2    Claude Code failed
    3    Status file missing or invalid
    4    Status file indicates error
    5    No project context (missing CLAUDE.md and no code files)
EOF
}

create_default_config() {
    mkdir -p "$CONFIG_DIR"
    cat > "$CONFIG_FILE" <<EOF
# agilar-coder configuration
# See: agilar-coder --help

# Custom prompt for development workflow (git, CI, code style, etc.)
USER_PROMPT="$DEFAULT_USER_PROMPT"

# Claude model (default: opus)
MODEL=$DEFAULT_MODEL

# Max agentic turns per PBI (default: 100)
MAX_TURNS=$DEFAULT_MAX_TURNS

# Verbose output (default: false)
VERBOSE=$DEFAULT_VERBOSE
EOF
    echo "Created default config at $CONFIG_FILE"
}

load_config() {
    # Set defaults first
    MODEL="$DEFAULT_MODEL"
    MAX_TURNS="$DEFAULT_MAX_TURNS"
    VERBOSE="$DEFAULT_VERBOSE"
    USER_PROMPT="$DEFAULT_USER_PROMPT"

    # Check if config exists, create if not
    if [[ ! -f "$CONFIG_FILE" ]]; then
        create_default_config
    fi

    # Source the config file
    # shellcheck source=/dev/null
    source "$CONFIG_FILE"
}

build_prompt() {
    local backlog_file="$1"
    local user_prompt_expanded

    # Replace [FILE_NAME] placeholder with actual backlog filename
    user_prompt_expanded="${USER_PROMPT//\[FILE_NAME\]/$backlog_file}"

    echo "$FIXED_PROMPT

Additional instructions:
$user_prompt_expanded

Backlog file to process: $backlog_file"
}

show_debug() {
    local backlog_file="$1"
    local count="$2"
    local full_prompt="$3"
    local mode_text

    if [[ -z "$count" ]]; then
        mode_text="unbound (until done)"
    else
        mode_text="bound ($count PBIs)"
    fi

    cat <<EOF
agilar-coder --debug
═════════════════════════════════════════

CONFIG:
  File: $CONFIG_FILE
  MODEL=$MODEL
  MAX_TURNS=$MAX_TURNS
  VERBOSE=$VERBOSE
  USER_PROMPT="$USER_PROMPT"

BACKLOG:
  File: $backlog_file
  Mode: $mode_text

COMMAND:
  claude --print --dangerously-skip-permissions --model $MODEL --max-turns $MAX_TURNS$([[ "$VERBOSE" == "true" ]] && echo " --verbose") "<prompt>"

FULL PROMPT:
─────────────────────────────────────────
$full_prompt
─────────────────────────────────────────

═════════════════════════════════════════
Debug mode: command was NOT executed.
EOF
}

run_claude() {
    local prompt="$1"
    local cmd=(claude --print --dangerously-skip-permissions --model "$MODEL" --max-turns "$MAX_TURNS")

    if [[ "$VERBOSE" == "true" ]]; then
        cmd+=(--verbose)
    fi

    cmd+=("$prompt")

    "${cmd[@]}"
}

read_status_file() {
    if [[ ! -f "$STATUS_FILE" ]]; then
        return 1
    fi

    # Source the status file to get variables
    # shellcheck source=/dev/null
    source "$STATUS_FILE"
}

print_separator() {
    echo "─────────────────────────────"
}

validate_project_context() {
    # Check for CLAUDE.md (explicit project context)
    if [[ -f "CLAUDE.md" ]]; then
        return 0
    fi

    # Check for common code files in current directory
    for ext in py js ts jsx tsx go rs java rb c cpp h hpp cs swift kt scala php; do
        if compgen -G "*.$ext" > /dev/null 2>&1; then
            return 0
        fi
    done

    # Check for common project structure directories
    for dir in src lib app pkg cmd internal; do
        if [[ -d "$dir" ]]; then
            return 0
        fi
    done

    # Check for common project files
    for file in package.json Cargo.toml go.mod pyproject.toml setup.py Gemfile pom.xml build.gradle; do
        if [[ -f "$file" ]]; then
            return 0
        fi
    done

    return 1
}

# ─────────────────────────────────────────────────────────────────────────────
# Main
# ─────────────────────────────────────────────────────────────────────────────

main() {
    local debug_mode=false
    local backlog_file=""
    local count=""
    local args=()

    # Parse flags first
    for arg in "$@"; do
        case "$arg" in
            -h|--help)
                show_help
                exit 0
                ;;
            --debug)
                debug_mode=true
                ;;
            *)
                args+=("$arg")
                ;;
        esac
    done

    # Show help if no arguments (after removing flags)
    if [[ ${#args[@]} -eq 0 && "$debug_mode" == false ]]; then
        show_help
        exit 0
    fi

    # Need at least backlog file in debug mode or normal mode
    if [[ ${#args[@]} -eq 0 ]]; then
        echo "Error: backlog-file is required"
        echo "Run 'agilar-coder --help' for usage."
        exit 1
    fi

    # Parse positional arguments
    backlog_file="${args[0]}"
    if [[ ${#args[@]} -ge 2 ]]; then
        count="${args[1]}"
    fi

    # Validate backlog file exists
    if [[ ! -f "$backlog_file" ]]; then
        echo "Error: Backlog file not found: $backlog_file"
        exit 1
    fi

    # Load configuration (creates default if missing)
    load_config

    # Build the full prompt
    local full_prompt
    full_prompt=$(build_prompt "$backlog_file")

    # Debug mode: show everything and exit
    if [[ "$debug_mode" == true ]]; then
        show_debug "$backlog_file" "$count" "$full_prompt"
        exit 0
    fi

    # ─────────────────────────────────────────
    # Validate project context
    # ─────────────────────────────────────────

    if ! validate_project_context; then
        echo "Error: No project context found"
        echo ""
        echo "  agilar-coder requires either:"
        echo "    - A CLAUDE.md file with project/tech stack info, OR"
        echo "    - An existing codebase (code files, src/, package.json, etc.)"
        echo ""
        echo "  For greenfield projects, create a CLAUDE.md file first."
        echo "  Example:"
        echo ""
        echo "    # Project: MyApp"
        echo "    ## Tech Stack"
        echo "    - Language: TypeScript"
        echo "    - Framework: Next.js"
        echo ""
        exit 5
    fi

    # ─────────────────────────────────────────
    # Main execution loop
    # ─────────────────────────────────────────

    local iteration=0
    local total_processed=0
    local mode_text

    if [[ -z "$count" ]]; then
        mode_text="unbound (until done)"
    else
        mode_text="bound ($count PBIs)"
    fi

    echo "agilar-coder v$VERSION"
    echo "Backlog: $backlog_file"
    echo "Mode: $mode_text"
    print_separator

    while true; do
        ((iteration++))
        echo "Starting iteration $iteration..."

        # Run Claude Code
        if ! run_claude "$full_prompt"; then
            echo ""
            echo "✗ Error: Claude Code failed (exit code $?)"
            echo "  Check output above for details."
            echo "  Aborting."
            exit 2
        fi

        # Read and validate status file
        if ! read_status_file; then
            echo ""
            echo "✗ Error: Status file missing after Claude run"
            echo "  Expected: $STATUS_FILE"
            echo "  Aborting."
            exit 3
        fi

        # Check for error status
        if [[ "${STATUS:-}" == "error" ]]; then
            echo ""
            echo "✗ Error reported by Claude:"
            echo "  ${ERROR:-Unknown error}"
            echo "  Aborting."
            exit 4
        fi

        # Validate required fields
        if [[ -z "${TOTAL:-}" || -z "${REMAINING:-}" || -z "${LAST_PBI:-}" ]]; then
            echo ""
            echo "✗ Error: Status file is invalid or incomplete"
            echo "  Aborting."
            exit 3
        fi

        ((total_processed++))

        # Print progress
        local done_count=$((TOTAL - REMAINING))
        echo ""
        echo "✓ Completed: $LAST_PBI"
        echo "  Progress: $done_count/$TOTAL done, $REMAINING remaining"

        # Check exit conditions
        if [[ "$REMAINING" -eq 0 ]]; then
            print_separator
            echo "✓ agilar-coder complete"
            echo "  Total PBIs processed: $total_processed"
            echo "  Backlog status: All PBIs done!"
            exit 0
        fi

        if [[ -n "$count" && "$iteration" -ge "$count" ]]; then
            print_separator
            echo "✓ agilar-coder complete"
            echo "  Total PBIs processed: $total_processed"
            echo "  Backlog status: $REMAINING PBIs remaining"
            exit 0
        fi

        print_separator
    done
}

main "$@"
